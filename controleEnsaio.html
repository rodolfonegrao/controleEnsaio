<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>üéª Controle de Frequ√™ncia nos Ensaios üé∫</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- autoTable plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 20px;
      background: #f4f8fc;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #2e3d59;
    }

    h2 {
      text-align: center;
      color: #2e3d59;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .controls input, .controls select, .controls button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .controls button {
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
    }

    .controls button:hover {
      background-color: #0056b3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #e2e6ea;
    }

    #tabela td:first-child {
      text-align: left;
    }

    .cordas { background-color: #fce4ec; }
    .madeiras { background-color: #e3f2fd; }
    .metais { background-color: #e8f5e9; }
    .organistas { background-color: #fff3e0; }
    .outros { background-color: #eeeeee; }

    .btn-remove {
      background-color: #dc3545 !important;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .btn-remove:hover {
      background-color: #a71d2a !important
    }

    #modal {
      display: none;
      position: absolute;
      z-index: 1000;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
    }

    #modal-content {
      background: white;
      max-width: 600px;
      margin: 100px auto;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    #modal-content h2 {
      margin-top: 0;
    }

    #modal-content h3 {
      margin-top: 0;
    }

    #modal-content ul {
      text-align: left;
    }

    #modal-content button {
      margin-top: 15px;
      padding: 6px 12px;
      background-color: #007bff;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    #modal-content button:hover {
      background-color: #0056b3;
    }


    .modal {
      display: none;
      position: absolute;
      z-index: 10;
      padding-top: 60px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: #fff;
      margin: auto;
      padding: 20px 30px;
      border: 1px solid #888;
      width: 400px;
      border-radius: 10px;
    }

    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 5px;
      text-align: center;
    }

    .modal-content h4 {
      margin-top: 1px;
      margin-bottom: 1px;
    }

    .modal-content label {
      display: block;
      margin: 10px 0 4px;
    }

    .modal-content input, .modal-content select {
      width: 100%;
      padding: 6px;
    }

    .modal-content .btn {
      width: 100%;
      padding: 8px;
      background-color: #4CAF50;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
    }

    .modal-content .btn:hover {
      background-color: #45a049;
    }

    .tabelaVisitantes {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    .tabelaVisitantes th, .tabelaVisitantes td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    .grupo-contador {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .grupo-contador label {
      width: 80px;
    }

    .grupo-contador button {
      padding: 5px 10px;
      font-size: 16px;
    }

    #subInstrumento, #sumInstrumento {
      margin: 4px 4px;
      padding: 5px 10px;
      font-size: 16px;
    }


    .close {
      float: right;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
    }

    .toast {
      position: fixed;
      top: 30px;
      right: 30px;
      background-color: #27ae60;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      z-index: 9999;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.4s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .oculto {
      display: none !important;
    }

    .visivel {
      display: flex !important;
    }

    .tabela-resumo {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    .tabela-resumo th, .tabela-resumo td {
      border: 1px solid #ccc;
      padding: 5px 10px;
      text-align: left;
    }

  </style>
</head>
<body>

  <h1>Rudge Ramos</h1>
  <h2>üéª Controle de Frequ√™ncia nos Ensaios üé∫</h2>

  <div id="mensagem" style="display:none; position: fixed; top: 10px; right: 10px; z-index: 9999; padding: 10px 20px; border-radius: 5px; font-weight: bold;"></div>

  <div class="controls">
    <label for="ano" class="oculto">Ano:</label>
    <select id="ano" class="oculto"></select>
    <button onclick="gerarTabela()" class="oculto">üìÖ Gerar Tabela</button>

    <button onclick="limparLista()">üóëÔ∏è Limpar Lista</button>
    <button onclick="abrirModal('modalAdicionar')">‚ûï Adicionar M√∫sico</button>
    <button onclick="importarListaGoogleDrive()">üì• Importar M√∫sicos</button>

    <button onclick="abrirModal('modalVisitantes')" class="btn">üé∫ Visitas | Irmandade | Hinos</button>

    <button onclick="mostrarResumoCompleto()">üßæ Resumo do Ensaio</button>

    <button onclick="importarResumoJsonGoogleDrive()">üìä Recuperar Resumo</button>

    <button class="oculto" class="btn" onclick="contarFrequenciaPorInstrumentoMesAtual()">üé∫ Total por Instrumento</button>
    <button onclick="contarFrequenciaMesAtual()">üìÖ Total M√™s Atual</button>
    <button class="oculto" onclick="contarFrequenciaAnual()">üìä Total no Ano</button>

    <button onclick="exportarExcel()">üìà Excel</button>
    <button onclick="exportarPDF()">üìÑ PDF</button>
    <button onclick="exportarJSON()">üíæ Salvar</button>

    <button id="btnAlternarMeses" class="btn" onclick="alternarColunasMes()">üëÅÔ∏è Apenas m√™s atual</button>
  </div>

  <div id="modalAdicionar" class="modal controls">
    <div class="modal-content">
      <span class="close" onclick="fecharModalManual()">&times;</span>
      <h3>Adicionar M√∫sico</h3>
      <label for="nome">Nome:</label>
      <input type="text" id="nome">
      <label for="instrumento">Instrumento:</label>
      <select id="instrumento">
        <option value="">-- Instrumento --</option>
        <option>Violino</option><option>Viola</option><option>Cello</option>
        <option>Flauta</option><option>Clarinete</option><option>Clarone Alto</option><option>Clarone Baixo</option>
        <option>Obo√©</option><option>Fagote</option><option>Saxofone Soprano</option>
        <option>Saxofone Alto</option><option>Saxofone Tenor</option><option>Saxofone Baritono</option>
        <option>Trompete</option><option>Trompa</option><option>Flugelhorn</option>
        <option>Euphonium</option><option>Trombone</option><option>Tuba</option>
        <option>Organistas</option>
      </select>
      <button style="margin-top: 10px" onclick="adicionarManual(); fecharModalManual()">Adicionar</button>
    </div>
  </div>

  <div id="modalVisitantes" class="modal controls">
    <div class="modal-content">
      <span class="close" onclick="fecharModalVisita()">&times;</span>

      <h4>Irmandade</h4>
      <div class="grupo-contador">
        <label>Irm√£os:</label>
        <button onclick="alterarContador('irmaos', -1)">‚àí</button>
        <span id="contador-irmaos">0</span>
        <button onclick="alterarContador('irmaos', 1)">+</button>
      </div>
      <div class="grupo-contador">
        <label>Irm√£s:</label>
        <button onclick="alterarContador('irmas', -1)">‚àí</button>
        <span id="contador-irmas">0</span>
        <button onclick="alterarContador('irmas', 1)">+</button>
      </div>

      <hr style="border: none; height: 3px; background-color: #ccc; margin: 15px 0;">

      <h4>M√∫sicos</h4>

      <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
        <!--<label for="selectInstrumentoVisitante">Instrumento:</label>-->
        <select id="selectInstrumentoVisitante" style="flex: 1;">
          <option value="">-- Instrumento --</option>
          <option>Violino</option><option>Viola</option><option>Cello</option>
          <option>Flauta</option><option>Clarinete</option><option>Clarone Alto</option><option>Clarone Baixo</option>
          <option>Obo√©</option><option>Fagote</option><option>Saxofone Soprano</option>
          <option>Saxofone Alto</option><option>Saxofone Tenor</option><option>Saxofone Baritono</option>
          <option>Trompete</option><option>Trompa</option><option>Flugelhorn</option>
          <option>Euphonium</option><option>Trombone</option><option>Tuba</option>
          <option>Organistas</option>
        </select>

        <button onclick="adicionarVisitante()">Adicionar</button>
      </div>

      <table id="tabelaVisitantes" class="tabelaVisitantes">
        <thead>
          <tr>
            <th>Instrumento</th>
            <th>Quantidade</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <hr style="border: none; height: 3px; background-color: #ccc; margin: 15px 0;">

      <h4>Localidades</h4>
      
      <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
        <input type="text" id="nomeLocalidade" placeholder="Localidade" style="flex: 1;">
        <button onclick="adicionarLocalidade()">Adicionar</button>
      </div>

      <table id="tabelaLocalidade" class="tabelaVisitantes">
        <thead>
          <tr>
            <th>Nome</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody>
          <!-- Visitantes ser√£o inseridos aqui -->
        </tbody>
      </table>

      <hr style="border: none; height: 3px; background-color: #ccc; margin: 15px 0;">

      <h4>Hinos Tocados</h4>
      
      <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
        <input type="text" id="numeroHino" placeholder="Hino" style="flex: 1;">
        <button onclick="adicionarHino()">Adicionar</button>
      </div>

      <table id="tabelaHino" class="tabelaVisitantes">
        <thead>
          <tr>
            <th>Hino</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody>
          <!-- Visitantes ser√£o inseridos aqui -->
        </tbody>
      </table>

    </div>
  </div>



  <input type="file" id="file-input" accept=".json" style="display:none;" onchange="carregarJSON(event)">

  <table id="tabela">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Instrumento</th>
        <th>Fam√≠lia</th>
        <!-- Colunas de meses -->
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <div id="modal">
    <div id="modal-content">
      <span class="close" onclick="fecharModal()">&times;</span>
      <h3>Resumo de Frequ√™ncia</h3>
      <div id="resumo"></div>
      <div id="controlResumo" class="controls">
        <button onclick="salvarPrintResumoFamilia()">üì§ Print</button>
        <button onclick="fecharModal()">Fechar</button>
      </div>
    </div>
  </div>

  <div id="modalResumoCompleto" class="modal">
    <div id="modalInternaResumo" class="modal-content">
      <span class="close" onclick="fecharModalResumo()">&times;</span>
      <h3>Resumo Completo do Ensaio</h3>

      <div style="overflow-x:auto">
        <h4>Instrumentos</h4>
        <table id="resumoInstrumentos" class="tabela-resumo">
          <thead>
            <tr><th>Instrumento</th><th>Local</th><th>Visitas</th></tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><th>Total</th><th id="totalLocal">0</th><th id="totalVisitas">0</th></tr>
          </tfoot>
        </table>

        <!--<hr>

        <h4>Irmandade</h4>-->
        <table class="tabela-resumo" style="display: none;">
          <tbody>
            <tr><td>Irm√£s</td><td id="totalIrmas">0</td></tr>
            <tr><td>Irm√£os</td><td id="totalIrmaos">0</td></tr>
            <tr><th>Total</th><th id="totalIrmandade">0</th></tr>
          </tbody>
        </table>

        <hr style="border: none; height: 3px; background-color: #ccc; margin: 15px 0;">

        <h4>Contagem Geral</h4>
        <table class="tabela-resumo">
          <tbody>
            <tr><td>Irm√£s</td><td id="contagemIrmas">0</td></tr>
            <tr><td>Irm√£os</td><td id="contagemIrmaos">0</td></tr>
            <tr><td>M√∫sicos</td><td id="contagemMusicos">0</td></tr>
            <tr><th>Total</th><th id="contagemTotalGeral">0</th></tr>
          </tbody>
        </table>

        <hr style="border: none; height: 3px; background-color: #ccc; margin: 15px 0;">

        <h4>Hinos Tocados</h4>
        <table class="tabela-resumo">
          <tbody>
            <tr><td>Total</td><td id="totalHinos">0</td></tr>
          </tbody>
        </table>
        <span id="listaHinosSpan"></span>

        <hr style="border: none; height: 3px; background-color: #ccc; margin: 15px 0;">

        <h4>Localidades Visitando</h4>
        <ul id="listaLocalidades"></ul>
      </div>
      <div id="controlResumo" class="controls">
        <button onclick="exportarModalResumoComoJSON(); fecharModalResumo();">üíæ Salvar</button>
        <button onclick="enviarModalResumoPorWhatsApp(); fecharModalResumo();">üì± Enviar por WhatsApp</button>
        <button onclick="salvarPrintResumo()">üì§ Print</button>
      </div>
    </div>
  </div>

  <div id="mensagemSalvo" class="toast">
    ‚úÖ Salvo com sucesso!
  </div>

  <script>
    // Bloqueia F5 e Ctrl+R
    document.addEventListener("keydown", function (e) {
      if (
        e.key === "F5" || // tecla F5
        (e.ctrlKey && e.key.toLowerCase() === "r") || // Ctrl+R
        (e.metaKey && e.key.toLowerCase() === "r") // Command+R (Mac)
      ) {
        e.preventDefault();
        alert("Atualiza√ß√£o da p√°gina est√° desativada.");
      }
    });

    // Bloqueia refresh por outros motivos (como reload via menu ou bot√£o navegador)
    window.addEventListener("beforeunload", function (e) {
      e.preventDefault();
      e.returnValue = ""; // Necess√°rio para alguns navegadores
    });

    function abrirModal(id) {
      document.getElementById(id).style.display = "block";
    }

    function fecharModalManual() {
      document.getElementById("modalAdicionar").style.display = "none";
    }

    function adicionarMusico() {
      const nome = document.getElementById("nome").value.trim();
      const instrumento = document.getElementById("instrumento").value;

      if (!nome || !instrumento) {
        alert("Preencha todos os campos.");
        return;
      }

      // Adiciona novo m√∫sico ao array
      musicos.push({ nome, instrumento });
      salvarMusicos();
      renderizarTabela();
      document.getElementById("nome").value = "";
      document.getElementById("instrumento").value = "";
    }


    const familias = {
      Cordas: ["Violino", "Viola", "Cello"],
      Madeiras: ["Flauta", "Obo√©", "Fagote", "Clarinete", "Clarone Alto", "Clarone Baixo", "Saxofone Soprano", "Saxofone Alto", "Saxofone Tenor", "Saxofone Baritono"],
      Metais: ["Trompete", "Flugelhorn", "Trompa", "Trombone", "Tuba", "Euphonium"],
      Organistas: ["Organistas"]
    };

    let datasEnsaio = [];

    function classificarFamilia(instr) {
      for (const [familia, instrumentos] of Object.entries(familias)) {
        if (instrumentos.map(i => i.toLowerCase()).includes(instr.toLowerCase())) {
          return familia;
        }
      }
      return "Outros";
    }

    function gerarTabela() {
      const ano = parseInt(document.getElementById("ano").value);
      const thead = document.querySelector("#tabela thead tr");
      datasEnsaio = [];

      while (thead.cells.length > 3) thead.deleteCell(-1);

      for (let mes = 0; mes < 12; mes++) {
        const d = new Date(ano, mes, 1);
        let count = 0;
        while (d.getDay() !== 6 || ++count < 2) d.setDate(d.getDate() + 1);
        datasEnsaio.push(new Date(d));
        const th = document.createElement("th");
        th.textContent = d.toLocaleDateString("pt-BR");
        thead.appendChild(th);
      }

      document.querySelectorAll("#tabela tbody tr").forEach(row => row.remove());
      carregarDados();
    }

    function criarLinha(nome, instrumento, frequencias = {}) {
      const tbody = document.getElementById("tabela").querySelector("tbody");

      // Verificar se j√° existe um m√∫sico com o mesmo nome
      const nomesExistentes = Array.from(tbody.querySelectorAll("tr")).map(tr =>
        tr.dataset.nome?.trim().toLowerCase()
      );

      if (nomesExistentes.includes(nome.trim().toLowerCase())) {
        alert(`O nome "${nome}" j√° est√° na lista.`);
        return;
      }

      const tr = document.createElement("tr");
      tr.dataset.nome = nome;
      tr.dataset.instrumento = instrumento;

      const tdNome = document.createElement("td");
      tdNome.textContent = nome;

      const tdInstrumento = document.createElement("td");
      tdInstrumento.textContent = instrumento;

      const tdFamilia = document.createElement("td");
      const familia = classificarFamilia(instrumento);
      tdFamilia.textContent = familia;

      tr.appendChild(tdNome);
      tr.appendChild(tdInstrumento);
      tr.appendChild(tdFamilia);

      // Preencher os selects de frequ√™ncia
      datasEnsaio.forEach(data => {
        const td = document.createElement("td");
        const select = document.createElement("select");

        ["F", "P", "J", "E"].forEach(status => {
          const option = document.createElement("option");
          option.value = status;
          option.textContent = status;
          select.appendChild(option);
        });

        const dataFormatada = data.toLocaleDateString("pt-BR");
        if (frequencias[dataFormatada]) {
          select.value = frequencias[dataFormatada];
        }
        
        td.appendChild(select);
        tr.appendChild(td);

      });

      tr.classList.add(familia.toLowerCase()); // aplica cor por fam√≠lia

      // Encontrar a √∫ltima linha com o mesmo instrumento
      let ultimaPosicao = null;
      const linhas = Array.from(tbody.querySelectorAll("tr"));
      linhas.forEach((linha, index) => {
          if (linha.dataset.instrumento === tr.dataset.instrumento) {
              ultimaPosicao = index;
          }
      });

      // Inserir logo abaixo do √∫ltimo m√∫sico com o mesmo instrumento
      if (ultimaPosicao !== null) {
          linhas[ultimaPosicao].after(tr);
      } else {
          tbody.appendChild(tr); // Se n√£o existir, adiciona no final
      }
      
      //tbody.appendChild(tr);

      const tdRemover = document.createElement("td");
      const btn = document.createElement("button");
      btn.textContent = "üóëÔ∏è";
      btn.className = "btn btn-remover";
      btn.onclick = function () {
        if (confirm(`Deseja remover ${nome} da lista?`)) {
          tr.remove();
          exportarJSON();
          salvarDados();
        }
      };
      tdRemover.appendChild(btn);
      tr.appendChild(tdRemover);

      
    }

    function adicionarManual() {
      const nome = document.getElementById("nome").value.trim();
      const instrumento = document.getElementById("instrumento").value;
      if (!nome ) {
        alert("Por favor, preencha nome.");
        return;
      }
      if (!instrumento) {
        alert("Por favor, selecione um instrumento.");
        return;
      }
      
      criarLinha(nome, instrumento);
      
      document.getElementById("nome").value = "";
      document.getElementById("instrumento").value = "";

      exportarJSON();
      salvarDados();
    }

    function importarListaGoogleDrive() {
      const url = "https://script.google.com/macros/s/AKfycbyGOT_Zib7x596O-jMTdq7Nzhl3mgV4ntGPRR8cFy-FEEXHt5wZ7v3MLJKwsPM2ceFqjw/exec";

      fetch(url)
        .then(response => response.json())
        .then(data => {
          data.forEach(musico => {
            criarLinha(musico.nome, musico.instrumento, musico.frequencias);
          });
          salvarDados();
          mostrarMensagem("Lista importada do Google Drive com sucesso!");
        })
        .catch(error => {
          mostrarMensagem("Erro ao importar do Drive:", error);
        });
    }

    function importarJSON() {
      document.getElementById("file-input").click();
    }

    function carregarJSON(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);

          if (!Array.isArray(data)) {
            alert("Formato de arquivo inv√°lido.");
            return;
          }

          musicos = [];

          data.forEach(item => {
            if (item.nome && item.instrumento) {
              musicos.push({ nome: item.nome, instrumento: item.instrumento });
              criarLinha(item.nome, item.instrumento, item.frequencias);
            }
          });
          
          // Ap√≥s renderizar a tabela, aplicar frequ√™ncias
          setTimeout(() => {
            const meses = datasEnsaio.map(data => data.toLocaleDateString("pt-BR"));

            data.forEach(item => {
              if (item.frequencias) {
                const row = document.querySelector(
                  `#tabela tbody tr[data-nome="${item.nome}"][data-instrumento="${item.instrumento}"]`
                );

                if (row) {
                  const selects = row.querySelectorAll("select");
                  meses.forEach((mes, i) => {
                    if (item.frequencias[mes]) {
                      selects[i].value = item.frequencias[mes];
                    }
                  });
                }
              }
            });
          }, 50); // Pequeno atraso para garantir que o DOM esteja pronto

          salvarDados(); // Atualiza localStorage
        } catch (err) {
          alert("Erro ao carregar o arquivo.");
          console.error(err);
        }
      };

      reader.readAsText(file);
    }

    function salvarDados() {
      const dados = [];
      const meses = datasEnsaio.map(data => data.toLocaleDateString("pt-BR"));
      document.querySelectorAll("#tabela tbody tr").forEach(row => {

        const selects = row.querySelectorAll("select");
        const frequenciasList = {};

        selects.forEach((select, i) => {
          frequenciasList[meses[i]] = select.value;
        });

        dados.push({
          nome: row.dataset.nome,
          instrumento: row.dataset.instrumento,
          frequencias: frequenciasList
        });

      });
      //mostrarMensagemSalvo();
      localStorage.setItem("musicos", JSON.stringify(dados));
    }

    function mostrarMensagemSalvo() {
      const msg = document.getElementById("mensagemSalvo");
      msg.classList.add("show");

      // Oculta ap√≥s 2 segundos
      setTimeout(() => {
        msg.classList.remove("show");
      }, 2000);
    }

    function iniciarSalvamentoAutomatico() {
      setInterval(() => {
        //salvarDados();
      }, 60000); // 30.000 ms = 30 segundos
    }

    function carregarDados() {
      const salvos = localStorage.getItem("musicos");
      if (salvos) {
        const lista = JSON.parse(salvos);
        lista.forEach(item => criarLinha(item.nome, item.instrumento, item.frequencias));
      }
    }

    function limparLista() {
      const confirmar = confirm("Tem certeza que deseja apagar toda a lista de m√∫sicos?");
      if (!confirmar) return;

      musicos = [];
      localStorage.removeItem("musicos");
      const tbody = document.getElementById("tabela").querySelector("tbody");
      tbody.innerHTML = "";
    }

    function importarResumoJsonGoogleDrive() {
      const url = "https://script.google.com/macros/s/AKfycbyxDR0Gy4u3khH8bqOR7AWKgx6VJecYKPmJDkh15MVxoJghRSEEI67I_zeNkeLdbt-I/exec";

      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error("Erro na requisi√ß√£o: " + response.status);
          }
          return response.json();
        })
        .then(json => {
          // Chama a fun√ß√£o que vai montar o modal
          carregarResumoDeJson(json);
        })
        .catch(error => {
          mostrarMensagem("Erro ao importar resumo do Drive!");
        });

    }

    function carregarResumoDeJson(dados) {
      let html = `
        <span class="close" onclick="fecharModalResumo()">&times;</span>
        <h3>Resumo Completo do Ensaio</h3>

        <h4>Instrumentos</h4>
        <table border="1" style="border-collapse:collapse; width:100%;">
            <tr>
                <th>Instrumento</th>
                <th>Local</th>
                <th>Visitas</th>
            </tr>
            ${dados.instrumentos.map(inst => `
                <tr>
                    <td>${inst.instrumento}</td>
                    <td style="text-align:center;">${inst.local}</td>
                    <td style="text-align:center;">${inst.visitas}</td>
                </tr>
            `).join("")}
            <tr>
                <th>Total</th>
                <th id="totalLocal" style="text-align:center;">${dados.totalInstrumentos.local}</th>
                <th id="totalVisitas" style="text-align:center;">${dados.totalInstrumentos.visitas}</th>
            </tr>
        </table>

        <hr style="border: none; height: 3px; background-color: #ccc; margin: 15px 0;">

        <h4>Contagem Geral</h4>
        <table class="tabela-resumo">
          <tbody>
            <tr><td>Irm√£s</td><td id="contagemIrmas">${dados.contagemGeral.irmas}</td></tr>
            <tr><td>Irm√£os</td><td id="contagemIrmaos">${dados.contagemGeral.irmaos}</td></tr>
            <tr><td>M√∫sicos</td><td id="contagemMusicos">${dados.contagemGeral.musicos}</td></tr>
            <tr><th>Total</th><th id="contagemTotalGeral">${dados.contagemGeral.total}</th></tr>
          </tbody>
        </table>

        <hr style="border: none; height: 3px; background-color: #ccc; margin: 15px 0;">

        <h4>Hinos Tocados</h4>
        <table class="tabela-resumo">
          <tbody>
            <tr><td>Total</td><td id="totalHinos">${dados.hinosTocados.total}</td></tr>
          </tbody>
        </table>
        <span id="listaHinosSpan">${dados.hinosTocados.lista.join(", ")}</span>

        <hr style="border: none; height: 3px; background-color: #ccc; margin: 15px 0;">

        <h4>Localidades Visitando</h4>
        <ul id="listaLocalidades">${dados.localidadesVisitando.map(local => `<li>${local}</li>`).join("")}</ul>
        
        <div id="controlResumo" class="controls">
          <button onclick="enviarModalResumoPorWhatsApp(); fecharModalResumo();">üì± Enviar por WhatsApp</button>
          <button onclick="salvarPrintResumo()">üì§ Print</button>
        </div>
      `;

      // Exibir no modal (mesma estrutura do modalResumoCompleto)
      const modal = document.getElementById("modalResumoCompleto");
      const modalContent = modal.querySelector(".modal-content");
      modalContent.innerHTML = html;

      modal.style.display = "block";
  }


    /* Inicio das Functions de Calculos */

    function contarFrequencia() {
      contarFrequenciaAnual();
    }

    function contarFrequenciaPorInstrumentoMesAtual() {
      const instrumentosContagem = {};

      const anoSelecionado = parseInt(document.getElementById("ano").value);
      const hoje = new Date();
      const mesAtual = hoje.getMonth();
      const segundoSabado = datasEnsaio.find(data => data.getMonth() === mesAtual && data.getFullYear() === anoSelecionado);
      const dataFormatada = segundoSabado.toLocaleDateString("pt-BR");

      document.querySelectorAll("#tabela tbody tr").forEach(row => {
        const instrumento = row.dataset.instrumento;
        const selects = row.querySelectorAll("select");
        if (selects.length > mesAtual) {
          const valor = selects[mesAtual].value;
          if (!instrumentosContagem[instrumento]) {
            instrumentosContagem[instrumento] = { P: 0, F: 0, J: 0, E: 0 };
          }
          if (valor) {
            instrumentosContagem[instrumento][valor] += 1;
          }
        }
      });

      mostrarResumoModal(instrumentosContagem, `Frequ√™ncia - ${dataFormatada}`);
    }

    function mostrarResumoInstrumentoModal(resumo, titulo) {
      let html = `
        <table style="width:100%; text-align:center; border-collapse:collapse; overflow-y: auto;">
          <thead>
            <tr>
              <th>Instrumento</th>
              <th>Presente</th>
              <th>Falta</th>
              <th>Justificado</th>
              <th>Enfermo</th>
            </tr>
          </thead>
          <tbody>
      `;

      let total = { P: 0, F: 0, J: 0, E: 0 };
      for (const [fam, contagem] of Object.entries(resumo)) {
        html += `
          <tr>
            <td><strong>${fam}</strong></td>
            <td>${contagem.P}</td>
            <td>${contagem.F}</td>
            <td>${contagem.J}</td>
            <td>${contagem.E}</td>
          </tr>
        `;
        total.P += contagem.P;
        total.F += contagem.F;
        total.J += contagem.J;
        total.E += contagem.E;
      }

      html += `
          <tr style="font-weight:bold; background:#f0f0f0;">
            <td>Total Geral</td>
            <td>${total.P}</td>
            <td>${total.F}</td>
            <td>${total.J}</td>
            <td>${total.E}</td>
          </tr>
        </tbody>
      </table>`;

      document.querySelector("#modal-content h3").textContent = titulo;
      document.getElementById("resumo").innerHTML = html;
      document.getElementById("modal").style.display = "block";
    }

    function contarFrequenciaMesAtual() {
      const resumo = {
        Cordas: { P: 0, F: 0, J: 0, E: 0 },
        Madeiras: { P: 0, F: 0, J: 0, E: 0 },
        Metais: { P: 0, F: 0, J: 0, E: 0 },
        Organistas: { P: 0, F: 0, J: 0, E: 0 },
        Outros: { P: 0, F: 0, J: 0, E: 0 }
      };

      const hoje = new Date();
      const mesAtual = hoje.getMonth();

      document.querySelectorAll("#tabela tbody tr").forEach(row => {
        const familia = classificarFamilia(row.dataset.instrumento);
        const selects = row.querySelectorAll("select");
        if (selects.length > mesAtual) {
          const valor = selects[mesAtual].value;
          if (resumo[familia][valor] !== undefined) {
            resumo[familia][valor]++;
          }
        }
      });

      mostrarResumoModal(resumo, "Frequ√™ncia - M√™s Atual");
    }

    function contarFrequenciaAnual() {
      const resumo = {
        Cordas: { P: 0, F: 0, J: 0, E: 0 },
        Madeiras: { P: 0, F: 0, J: 0, E: 0 },
        Metais: { P: 0, F: 0, J: 0, E: 0 },
        Organistas: { P: 0, F: 0, J: 0, E: 0 },
        Outros: { P: 0, F: 0, J: 0, E: 0 }
      };

      document.querySelectorAll("#tabela tbody tr").forEach(row => {
        const familia = classificarFamilia(row.dataset.instrumento);
        row.querySelectorAll("select").forEach(select => {
          const valor = select.value;
          if (resumo[familia][valor] !== undefined) {
            resumo[familia][valor]++;
          }
        });
      });

      mostrarResumoModal(resumo, "Frequ√™ncia - Anual");
    }

    function mostrarResumoModal(resumo, titulo) {
      let html = `
        <table style="width:100%; text-align:center; border-collapse:collapse;">
          <thead>
            <tr>
              <th>Fam√≠lia</th>
              <th>Presente</th>
              <th>Falta</th>
              <th>Justificado</th>
              <th>Enfermo</th>
            </tr>
          </thead>
          <tbody>
      `;

      let total = { P: 0, F: 0, J: 0, E: 0 };
      for (const [fam, contagem] of Object.entries(resumo)) {
        html += `
          <tr>
            <td><strong>${fam}</strong></td>
            <td>${contagem.P}</td>
            <td>${contagem.F}</td>
            <td>${contagem.J}</td>
            <td>${contagem.E}</td>
          </tr>
        `;
        total.P += contagem.P;
        total.F += contagem.F;
        total.J += contagem.J;
        total.E += contagem.E;
      }

      html += `
          <tr style="font-weight:bold; background:#f0f0f0;">
            <td>Total Geral</td>
            <td>${total.P}</td>
            <td>${total.F}</td>
            <td>${total.J}</td>
            <td>${total.E}</td>
          </tr>
        </tbody>
      </table>`;

      document.querySelector("#modal-content h3").textContent = titulo;
      document.getElementById("resumo").innerHTML = html;
      document.getElementById("modal").style.display = "block";
    }

    function mostrarResumoCompleto() {
      const mapaInstrumentos = {};
      let totalIrmas = 0;
      let totalIrmaos = 0;

      // --- 1. CONTAR INSTRUMENTOS (LOCAL) ---
      const linhas = document.querySelectorAll("#tabela tbody tr");
      const hoje = new Date();
      const mesAtual = hoje.getMonth(); // 0 = Janeiro, 11 = Dezembro

      linhas.forEach(linha => {
        const instrumento = linha.getAttribute("data-instrumento");
        const tipo = linha.getAttribute("data-tipo"); // 'irma' ou 'irmao'
        if (tipo === "irma") totalIrmas++;
        else if (tipo === "irmao") totalIrmaos++;

        if (!instrumento) return;

        const selects = linha.querySelectorAll("select");
        if (selects.length === 0) return;

        const selectMes = selects[mesAtual];
        if (!selectMes || selectMes.value !== "P") return;

        mapaInstrumentos[instrumento] = mapaInstrumentos[instrumento] || { local: 0, visitas: 0 };
        mapaInstrumentos[instrumento].local += 1;
      });


      // --- 2. CONTAR INSTRUMENTOS (VISITANTES) ---
      const visitantes = document.querySelectorAll("#tabelaVisitantes tbody tr");
      visitantes.forEach(row => {
        const cells = row.querySelectorAll("td");
        if (cells.length < 2) return;

        const instrumento = cells[0].textContent.trim();
        const qtd = parseInt(cells[1].textContent.trim() || "0", 10);

        if (!instrumento) return;

        mapaInstrumentos[instrumento] = mapaInstrumentos[instrumento] || { local: 0, visitas: 0 };
        mapaInstrumentos[instrumento].visitas += qtd;
      });

      // --- 3. PREENCHER TABELA DE INSTRUMENTOS ---
      const tbody = document.querySelector("#resumoInstrumentos tbody");
      tbody.innerHTML = "";
      let totalLocal = 0;
      let totalVisitas = 0;

      for (const instrumento in mapaInstrumentos) {
        const linha = document.createElement("tr");
        const tdInst = document.createElement("td");
        const tdLoc = document.createElement("td");
        const tdVis = document.createElement("td");

        tdInst.textContent = instrumento;
        tdLoc.textContent = mapaInstrumentos[instrumento].local;
        tdVis.textContent = mapaInstrumentos[instrumento].visitas;

        linha.appendChild(tdInst);
        linha.appendChild(tdLoc);
        linha.appendChild(tdVis);
        tbody.appendChild(linha);

        totalLocal += mapaInstrumentos[instrumento].local;
        totalVisitas += mapaInstrumentos[instrumento].visitas;
      }

      document.getElementById("totalLocal").textContent = totalLocal;
      document.getElementById("totalVisitas").textContent = totalVisitas;

      // --- 4. IRMANDADE ---
      // --- CONTAR IRMANDADES (PRESENTES NO M√äS ATUAL) ---
      totalIrmas = document.getElementById("contador-irmas").textContent;
      totalIrmaos = document.getElementById("contador-irmaos").textContent;
      document.getElementById("totalIrmas").textContent = totalIrmas;
      document.getElementById("totalIrmaos").textContent = totalIrmaos;
      document.getElementById("totalIrmandade").textContent = parseInt(totalIrmas) + parseInt(totalIrmaos);

      // --- 5. CONTAGEM GERAL ---
      const totalMusicos = parseInt(totalLocal) + parseInt(totalVisitas);
      const totalGeral = parseInt(totalMusicos) + parseInt(totalIrmandade);
      document.getElementById("contagemIrmas").textContent = totalIrmas;
      document.getElementById("contagemIrmaos").textContent = totalIrmaos;
      document.getElementById("contagemMusicos").textContent = totalMusicos;
      document.getElementById("contagemTotalGeral").textContent = parseInt(totalIrmas) + parseInt(totalIrmaos) + parseInt(totalMusicos);

      // --- 6. HINOS TOCADOS ---
      const hinos = document.querySelectorAll("#tabelaHino tbody tr");
      document.getElementById("totalHinos").textContent = hinos.length;
      const listaHinos = Array.from(hinos)
        .map(row => row.cells[0]?.textContent.trim()) // Ajuste o √≠ndice se necess√°rio
        .filter(hino => hino)
        .join(" | ");

      document.getElementById("listaHinosSpan").textContent = listaHinos;

      // --- 7. LOCALIDADES VISITANDO ---
      const localidades = new Set();
      const localidadeItens = document.querySelectorAll("#tabelaLocalidade tbody tr td");
      localidadeItens.forEach(td => {
        const texto = td.textContent.trim();
        if (texto && texto.trim() !== "üóëÔ∏è") localidades.add(texto);
      });

      const ul = document.getElementById("listaLocalidades");
      ul.innerHTML = "";
      localidades.forEach(loc => {
        const li = document.createElement("li");
        li.textContent = loc;
        ul.appendChild(li);
      });

      abrirModal("modalResumoCompleto");
    }

    function fecharModal() {
      document.getElementById("modal").style.display = "none";
    }

    function fecharModalResumo() {
      document.getElementById("modalResumoCompleto").style.display = "none";
    }
    /* Final das Functions de Calculos */

    const anoSelect = document.getElementById("ano");
    for (let a = 2025; a <= 2035; a++) {
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      anoSelect.appendChild(opt);
    }
    anoSelect.value = new Date().getFullYear();
    gerarTabela();

    /* Inicio Function de Export */
    function exportarModalResumoComoJSON() {
      const anoSelecionado = parseInt(document.getElementById("ano").value);
      const hoje = new Date();
      const mesAtual = hoje.getMonth();
      const segundoSabado = datasEnsaio.find(data => data.getMonth() === mesAtual && data.getFullYear() === anoSelecionado);
      const dataFormatada = segundoSabado.toLocaleDateString("pt-BR");

      const nomeArquivo = `resumo_ensaio_${dataFormatada}.json`;

      const data = {
        instrumentos: [],
        totalInstrumentos: {
          local: parseInt(document.getElementById("totalLocal").textContent) || 0,
          visitas: parseInt(document.getElementById("totalVisitas").textContent) || 0
        },
        contagemGeral: {
          irmas: parseInt(document.getElementById("contagemIrmas").textContent) || 0,
          irmaos: parseInt(document.getElementById("contagemIrmaos").textContent) || 0,
          musicos: parseInt(document.getElementById("contagemMusicos").textContent) || 0,
          total: parseInt(document.getElementById("contagemTotalGeral").textContent) || 0
        },
        hinosTocados: {
          total: parseInt(document.getElementById("totalHinos").textContent) || 0,
          lista: document.getElementById("listaHinosSpan").textContent.split("|").map(h => h.trim()).filter(h => h)
        },
        localidadesVisitando: []
      };

      // Instrumentos
      const linhasInstrumentos = document.querySelectorAll("#resumoInstrumentos tbody tr");
      linhasInstrumentos.forEach(row => {
        const cols = row.querySelectorAll("td");
        if (cols.length === 3) {
          data.instrumentos.push({
            instrumento: cols[0].textContent.trim(),
            local: parseInt(cols[1].textContent.trim()) || 0,
            visitas: parseInt(cols[2].textContent.trim()) || 0
          });
        }
      });

      // Localidades
      const listaLocais = document.querySelectorAll("#listaLocalidades li");
      listaLocais.forEach(item => {
        const texto = item.textContent.trim();
        if (texto && texto !== "üóëÔ∏è") data.localidadesVisitando.push(texto);
      });

      // Download JSON
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });

      const url = "https://script.google.com/macros/s/AKfycbylSIUP-uWC8O5yrK_EgPzALj4JTPc48PFHRtvDZxcv0equ8U2ZrkvBpcV4i_yFWICL/exec"; 
    
      const payload = {
        filename: "musicos.json",
        content: JSON.stringify(blob)
      };
    
      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "text/plain;charset=utf-8"
        },
        body: JSON.stringify(data)
      })
      .then(response => response.text())
      .then(text => {
        mostrarMensagem("Arquivo salvo com sucesso!", "success");
      })
      .catch(error => {
        mostrarMensagem("Erro ao salvar JSON: " + error.message, "error");
      });
    }

    function enviarModalResumoPorWhatsApp() {
      const anoSelecionado = parseInt(document.getElementById("ano").value);
      const hoje = new Date();
      const mesAtual = hoje.getMonth();
      const segundoSabado = datasEnsaio.find(data => data.getMonth() === mesAtual && data.getFullYear() === anoSelecionado);
      const dataFormatada = segundoSabado.toLocaleDateString("pt-BR");

      let texto = `A Paz de Deus,\n\n`;

      texto += `*Rudge Ramos Ensaio ${dataFormatada}*\n\n`;
      
      // Instrumentos
      texto += "*M√∫sicos*\n";
      const linhasInstrumentos = document.querySelectorAll("#resumoInstrumentos tbody tr");
      linhasInstrumentos.forEach(row => {
        const cols = row.querySelectorAll("td");
        if (cols.length === 3) {
          const instrumento = cols[0].textContent.trim();
          const local = cols[1].textContent.trim();
          const visitas = cols[2].textContent.trim();
          texto += `${instrumento}: Local ${local} | Visitas ${visitas}\n`;
        }
      });

      const totalLocal = document.getElementById("totalLocal").textContent.trim();
      const totalVisitas = document.getElementById("totalVisitas").textContent.trim();
      texto += `Total: Local ${totalLocal} | Visitas ${totalVisitas}\n\n`;

      // Contagem Geral
      texto += "*Contagem Geral*\n";
      texto += `Irm√£s: ${document.getElementById("contagemIrmas").textContent.trim()}\n`;
      texto += `Irm√£os: ${document.getElementById("contagemIrmaos").textContent.trim()}\n`;
      texto += `M√∫sicos: ${document.getElementById("contagemMusicos").textContent.trim()}\n`;
      texto += `Total: ${document.getElementById("contagemTotalGeral").textContent.trim()}\n\n`;

      // Hinos
      texto += "*Hinos Tocados*\n";
      texto += `Total: ${document.getElementById("totalHinos").textContent.trim()}\n`;

      const listaHinos = document.getElementById("listaHinosSpan").textContent.trim();
      if (listaHinos) {
        texto += `Hinos: ${listaHinos.split("|").map(h => h.trim()).join(", ")}\n\n`;
      }

      // Localidades
      texto += "*Localidades Visitando*\n";
      const localidades = document.querySelectorAll("#listaLocalidades li");
      localidades.forEach(li => {
        const nome = li.textContent.trim();
        if (nome && nome !== "üóëÔ∏è") {
          texto += `- ${nome}\n`;
        }
      });

      //Encerramento
      texto += "\nDeus aben√ßoe grandemente a todos!";

      // Codifica o texto e cria o link do WhatsApp
      const textoCodificado = encodeURIComponent(texto);
      const linkWhatsapp = `https://wa.me/?text=${textoCodificado}`;

      // Abre o link em uma nova aba
      window.open(linkWhatsapp, "_blank");
    }

    function salvarPrintResumo() {
      const anoSelecionado = parseInt(document.getElementById("ano").value);
      const hoje = new Date();
      const mesAtual = hoje.getMonth();
      const segundoSabado = datasEnsaio.find(data => data.getMonth() === mesAtual && data.getFullYear() === anoSelecionado);
      const dataFormatada = segundoSabado.toLocaleDateString("pt-BR");

      const modal = document.getElementById("modalInternaResumo"); // ID da sua modal

      if (!modal) {
        alert("Modal n√£o encontrada!");
        return;
      }


      const button = document.getElementById("controlResumo");;
      button.className = "oculto";

      html2canvas(modal).then(canvas => {
        // Converte para base64
        const imgData = canvas.toDataURL("image/png");

        // Cria link para baixar a imagem localmente (opcional)
        const link = document.createElement("a");
        link.href = imgData;
        link.download = `resumo_ensaio_${dataFormatada}.png`;
        link.click();
/*
        // Abre WhatsApp Web com mensagem padr√£o
        const numero = "5511982725852"; // Coloque o n√∫mero no formato internacional
        const mensagem = encodeURIComponent("Segue o resumo do ensaio üìä (imagem em anexo)");
        const url = `https://wa.me/${numero}?text=${mensagem}`;
        window.open(url, "_blank");
*/

/*
        const url = "https://script.google.com/macros/s/AKfycbwjnlR2rr4fGpvpDaJ9EtADpVM6HDx_GQ_urQx6idDDP_vI7lDI7lZvuhYsLXB7MEey/exec";
        const numeros = ["5511982725852", "5511988550176"];
        const nomeArquivo = `resumo_ensaio_${dataFormatada}.png`;

        // Envia a imagem para o Apps Script
        fetch(url, {
            method: "POST",
            body: JSON.stringify({ 
              imagem: imgData}),
            headers: { "Content-Type": "application/json" }
        })
        .then(res => res.json())
        .then(data => {
            const linkImagem = data.url; // link p√∫blico gerado pelo Apps Script
            const mensagem = `Segue o resumo: ${linkImagem}`;

            // Envia para cada n√∫mero
            numeros.forEach((numero, index) => {
                setTimeout(() => {
                    const urlWhatsApp = `https://wa.me/${numero}?text=${encodeURIComponent(mensagem)}`;
                    window.open(urlWhatsApp, "_blank");
                }, index * 1500); // delay para evitar bloqueios
            });
        })
        .catch(err => mostrarMensagem("Erro ao salvar Imagem: " + err, "error"));
*/
      });
      button.className = "controls visivel";
    }

    function salvarPrintResumoFamilia() {
      const anoSelecionado = parseInt(document.getElementById("ano").value);
      const hoje = new Date();
      const mesAtual = hoje.getMonth();
      const segundoSabado = datasEnsaio.find(data => data.getMonth() === mesAtual && data.getFullYear() === anoSelecionado);
      const dataFormatada = segundoSabado.toLocaleDateString("pt-BR");

      const modal = document.getElementById("modal-content"); // ID da sua modal

      if (!modal) {
        alert("Modal n√£o encontrada!");
        return;
      }

      const button = document.getElementById("controlResumo");;
      button.className = "oculto";

      html2canvas(modal).then(canvas => {
        // Converte para base64
        const imgData = canvas.toDataURL("image/png");

        // Cria link para baixar a imagem localmente (opcional)
        const link = document.createElement("a");
        link.href = imgData;
        link.download = `resumo_familia_${dataFormatada}.png`;
        link.click();
/*
        // Abre WhatsApp Web com mensagem padr√£o
        const numero = "5511982725852"; // Coloque o n√∫mero no formato internacional
        const mensagem = encodeURIComponent("Segue o resumo do ensaio üìä (imagem em anexo)");
        const url = `https://wa.me/${numero}?text=${mensagem}`;
        window.open(url, "_blank");
*/

/*
        const url = "https://script.google.com/macros/s/AKfycbwjnlR2rr4fGpvpDaJ9EtADpVM6HDx_GQ_urQx6idDDP_vI7lDI7lZvuhYsLXB7MEey/exec";
        const numeros = ["5511982725852", "5511988550176"];
        const nomeArquivo = `resumo_ensaio_${dataFormatada}.png`;

        // Envia a imagem para o Apps Script
        fetch(url, {
            method: "POST",
            body: JSON.stringify({ 
              imagem: imgData}),
            headers: { "Content-Type": "application/json" }
        })
        .then(res => res.json())
        .then(data => {
            const linkImagem = data.url; // link p√∫blico gerado pelo Apps Script
            const mensagem = `Segue o resumo: ${linkImagem}`;

            // Envia para cada n√∫mero
            numeros.forEach((numero, index) => {
                setTimeout(() => {
                    const urlWhatsApp = `https://wa.me/${numero}?text=${encodeURIComponent(mensagem)}`;
                    window.open(urlWhatsApp, "_blank");
                }, index * 1500); // delay para evitar bloqueios
            });
        })
        .catch(err => mostrarMensagem("Erro ao salvar Imagem: " + err, "error"));
*/
      });
      button.className = "controls visivel";
    }

    function enviarPrintWhatsApp(numero) {
      const modal = document.getElementById("modalResumoCompleto");

      html2canvas(modal).then(canvas => {
          const base64Image = canvas.toDataURL("image/png");

          // Aqui voc√™ poderia enviar a imagem para o Google Apps Script e obter o link p√∫blico
          fetch("URL_DO_SEU_APPS_SCRIPT", {
              method: "POST",
              body: JSON.stringify({ imagem: base64Image }),
              headers: { "Content-Type": "application/json" }
          })
          .then(res => res.json())
          .then(data => {
              const linkImagem = data.url; // Link p√∫blico retornado pelo Apps Script
              const mensagem = `Segue o resumo: ${linkImagem}`;
              const urlWhatsApp = `https://wa.me/${numero}?text=${encodeURIComponent(mensagem)}`;
              window.open(urlWhatsApp, "_blank");
          })
          .catch(err => console.error("Erro ao enviar a imagem:", err));
      });
    }

    function obterTamanhoDiv(id) {
      const div = document.getElementById(id);

      if (!div) {
        console.error("Div n√£o encontrada!");
        return;
      }

      const tamanho = div.getBoundingClientRect();
      
      console.log("Largura:", tamanho.width, "px");
      console.log("Altura:", tamanho.height, "px");
      
      return { largura: tamanho.width, altura: tamanho.height };
    }

    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const ano = parseInt(document.getElementById("ano").value);

      doc.setFontSize(14);
      doc.text(`Frequ√™ncia de M√∫sicos nos Ensaios de ${ano}`, 14, 15);

      const headers = [];
      const datasFormatadas = [];

      // Cabe√ßalhos fixos
      headers.push("Nome", "Instrumento");

      // Datas de ensaio formatadas
      const mesesAbreviados = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];

      datasEnsaio.forEach(data => {
        const mes = data.getMonth(); // 0 a 11
        const ano = data.getFullYear();
        const formatada = `${mesesAbreviados[mes]}`;
        headers.push(formatada);
        datasFormatadas.push(formatada);
      })

      headers.push("%");

      const body = [];
      const rows = document.querySelectorAll("#tabela tbody tr");

      rows.forEach(row => {
        const rowData = [];

        rowData.push(row.dataset.nome);
        rowData.push(row.dataset.instrumento);

        let presencas = 0;
        let totalMeses = 0;
        
        // Coleta os valores selecionados dos <select> de frequ√™ncia
        row.querySelectorAll("select").forEach(select => {
          const valor = select.value;
          rowData.push(valor);
          totalMeses++;
          if (valor === "P") presencas++;
        });

        // Calcula % de presen√ßa
        const percentual = totalMeses > 0 ? ((presencas / totalMeses) * 100).toFixed(1) + "%" : "0%";
        rowData.push(percentual);

        body.push(rowData);
      });

      // Gerar a tabela no PDF
      doc.autoTable({
        head: [headers],
        body: body,
        startY: 25,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [41, 128, 185] },
        theme: 'grid',
        showHead: 'firstPage',
        didDrawPage: function (data) {
          if (data.pageNumber > 1) {
            doc.setFontSize(10);
            //doc.text(`Frequ√™ncia - Continua√ß√£o`, 14, 15);
          }
        }
      });

      doc.save(`frequencia_musicos_${ano}.pdf`);
    }

    function exportarJSON() {
      const anoSelecionado = parseInt(document.getElementById("ano").value);
      const dataExportada = [];
      const meses = datasEnsaio.map(data => data.toLocaleDateString("pt-BR"));

      const rows = document.querySelectorAll("#tabela tbody tr");

      rows.forEach(row => {
        const nome = row.dataset.nome;
        const instrumento = row.dataset.instrumento;
        const familia = classificarFamilia(instrumento);

        const selects = row.querySelectorAll("select");
        const frequencias = {};

        selects.forEach((select, i) => {
          frequencias[meses[i]] = select.value;
        });

        dataExportada.push({
          nome,
          instrumento,
          familia,
          frequencias
        });
      });

      const blob = new Blob([JSON.stringify(dataExportada, null, 2)], {
        type: "application/json"
      });

      const url = "https://script.google.com/macros/s/AKfycbxayz9u9stke7ZM1O8SAPVH5DNZdZy68mXBxQF1olc94CawGVGr0uE9IlOJEstzZOjJ/exec"; // substitua pela sua
    
      const payload = {
        filename: "musicos.json",
        content: JSON.stringify(blob)
      };
    
      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "text/plain;charset=utf-8"
        },
        body: JSON.stringify(dataExportada)
      })
      .then(response => response.text())
      .then(text => {
        mostrarMensagem("Arquivo salvo com sucesso!", "success");
      })
      .catch(error => {
        mostrarMensagem("Erro ao salvar JSON: " + error.message, "error");
      });
      salvarDados();
    }

    function mostrarMensagem(texto, tipo = "success") {
      const div = document.getElementById("mensagem");
      div.textContent = texto;
      div.style.display = "block";
      div.style.backgroundColor = tipo === "success" ? "#4CAF50" : "#f44336";
      div.style.color = "white";
      div.style.boxShadow = "0 0 5px rgba(0,0,0,0.3)";
    
      setTimeout(() => {
        div.style.display = "none";
      }, 4000);
    }

    function exportarExcel() {
      const headers = [];
      const ano = parseInt(document.getElementById("ano").value);

      // Cabe√ßalhos fixos
      headers.push("Nome", "Instrumento", "Fam√≠lia");

      // Datas de ensaio (1 por m√™s)
      datasEnsaio.forEach(data => {
        headers.push(data.toLocaleDateString("pt-BR"));
      });

      headers.push("%");

      const data = [];
      const rows = document.querySelectorAll("#tabela tbody tr");



      rows.forEach(row => {
        const rowData = [];
        rowData.push(row.dataset.nome);
        rowData.push(row.dataset.instrumento);
        rowData.push(classificarFamilia(row.dataset.instrumento));

        let presencas = 0;
        let totalMeses = 0;
        
        // Coleta os valores selecionados dos <select> de frequ√™ncia
        row.querySelectorAll("select").forEach(select => {
          const valor = select.value;
          rowData.push(valor);
          totalMeses++;
          if (valor === "P") presencas++;
        });

        // Calcula % de presen√ßa
        const percentual = totalMeses > 0 ? ((presencas / totalMeses) * 100).toFixed(1) + "%" : "0%";
        rowData.push(percentual);

        data.push(rowData);
      });

      const wsData = [headers, ...data];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Frequ√™ncia");

      XLSX.writeFile(wb, "frequencia_musicos_"+ano+".xlsx");
    }

    /* Final Function de Export */

    let visitantes = {};

    function adicionarVisitante() {
      const select = document.getElementById("selectInstrumentoVisitante");
      const instrumento = select.value;

      if (!instrumento) return alert("Selecione um instrumento.");

      if (visitantes[instrumento]) {
        visitantes[instrumento]++;
      } else {
        visitantes[instrumento] = 1;
      }

      atualizarTabelaVisitantes();
    }

    function atualizarTabelaVisitantes() {
      const tbody = document.querySelector("#tabelaVisitantes tbody");
      tbody.innerHTML = "";

      for (const instrumento in visitantes) {
        const tr = document.createElement("tr");

        const tdNome = document.createElement("td");
        tdNome.textContent = instrumento;

        const tdQtd = document.createElement("td");
        tdQtd.textContent = visitantes[instrumento];

        const tdAcoes = document.createElement("td");

        const btnMenos = document.createElement("button");
        btnMenos.textContent = "‚àí";
        btnMenos.id = "subInstrumento"
        btnMenos.onclick = () => {
          if (visitantes[instrumento] > 1) {
            visitantes[instrumento]--;
          } else {
            delete visitantes[instrumento];
          }
          atualizarTabelaVisitantes();
        };

        const btnMais = document.createElement("button");
        btnMais.textContent = "+";
        btnMais.id = "sumInstrumento";
        btnMais.onclick = () => {
          visitantes[instrumento]++;
          atualizarTabelaVisitantes();
        };

        tdAcoes.appendChild(btnMenos);
        tdAcoes.appendChild(btnMais);

        tr.appendChild(tdNome);
        tr.appendChild(tdQtd);
        tr.appendChild(tdAcoes);

        tbody.appendChild(tr);
      }
    }

    let dadosIrmaos = {
      irmaos: 0,
      irmas: 0
    };

    function alterarContador(tipo, delta) {
      dadosIrmaos[tipo] = Math.max(0, (dadosIrmaos[tipo] || 0) + delta);
      document.getElementById(`contador-${tipo}`).textContent = dadosIrmaos[tipo];
    }

    function adicionarLocalidade() {
      const nomeInput = document.getElementById("nomeLocalidade");
      const nome = nomeInput.value.trim();
      if (nome === "") {
        alert("Digite um nome.");
        return;
      }

      const tbody = document.getElementById("tabelaLocalidade").querySelector("tbody");
      const tr = document.createElement("tr");

      const tdNome = document.createElement("td");
      tdNome.textContent = nome;

      const tdAcoes = document.createElement("td");
      const btnRemover = document.createElement("button");
      btnRemover.textContent = "üóëÔ∏è";
      btnRemover.className = "btn-remove";
      btnRemover.onclick = () => tr.remove();
      tdAcoes.appendChild(btnRemover);

      tr.appendChild(tdNome);
      tr.appendChild(tdAcoes);
      tbody.appendChild(tr);

      nomeInput.value = "";
    }

    function adicionarHino() {
      const nomeInput = document.getElementById("numeroHino");
      const nome = nomeInput.value.trim();
      if (nome === "") {
        alert("Digite um n√∫mero de Hino.");
        return;
      }

      const tbody = document.getElementById("tabelaHino").querySelector("tbody");
      const tr = document.createElement("tr");

      const tdNome = document.createElement("td");
      tdNome.textContent = nome;

      const tdAcoes = document.createElement("td");
      const btnRemover = document.createElement("button");
      btnRemover.textContent = "üóëÔ∏è";
      btnRemover.onclick = () => tr.remove();
      tdAcoes.appendChild(btnRemover);

      tr.appendChild(tdNome);
      tr.appendChild(tdAcoes);
      tbody.appendChild(tr);

      nomeInput.value = "";
    }

    function fecharModalVisita() {
      document.getElementById("modalVisitantes").style.display = "none";
    }

    let mostrandoMesAtual = true;

    function alternarColunasMes() {
      const tabela = document.getElementById("tabela");
      const headerCells = tabela.querySelectorAll("thead th");
      const linhas = tabela.querySelectorAll("tbody tr");

      // Obt√©m o √≠ndice da coluna do m√™s atual
      const hoje = new Date();
      const mesAtualIndex = datasEnsaio.findIndex(data => {
        return (
          data.getFullYear() === hoje.getFullYear() &&
          data.getMonth() === hoje.getMonth()
        );
      });

      if (mesAtualIndex === -1) {
        alert("O m√™s atual n√£o est√° entre os ensaios cadastrados.");
        return;
      }

      // Come√ßa ap√≥s as 3 primeiras colunas: Nome, Instrumento, Fam√≠lia
      const inicioColunasMeses = 3;

      for (let i = 0; i < datasEnsaio.length; i++) {
        const mostrar = !mostrandoMesAtual || i === mesAtualIndex;
        
        // Header
        if (headerCells[inicioColunasMeses + i]) {
          headerCells[inicioColunasMeses + i].style.display = mostrar ? "" : "none";
        }

        // Linhas
        linhas.forEach(linha => {
          const td = linha.children[inicioColunasMeses + i];
          if (td) td.style.display = mostrar ? "" : "none";
        });

        // Atualiza o texto do bot√£o
        const btn = document.getElementById("btnAlternarMeses");
        btn.textContent = mostrar ? "üëÅÔ∏è Apenas m√™s atual" : "üëÅÔ∏è Todos os meses";

      }

      mostrandoMesAtual = !mostrandoMesAtual;
    }

    window.onload = () => {
      iniciarSalvamentoAutomatico();
    };
  </script>
</body>
</html>
